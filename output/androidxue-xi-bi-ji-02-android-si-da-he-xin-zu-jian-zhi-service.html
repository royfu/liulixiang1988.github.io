<!DOCTYPE html>
<html lang="en">
<head>
        <title>Android学习笔记-02 Android 四大核心组件之Service</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="./theme/css/main.css" type="text/css" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="./css/ie.css"/>
                <script src="./js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="./css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href=".">理想国 </a></h1>
                <nav>
                    <a href="./category/android.html">Android</a>&nbsp;
                    <a href="./category/python.html">Python</a>&nbsp;
                    <a href="./category/sheng-huo.html">生活</a>&nbsp;
                </nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="androidxue-xi-bi-ji-02-android-si-da-he-xin-zu-jian-zhi-service.html" rel="bookmark"
           title="Permalink to Android学习笔记-02 Android 四大核心组件之Service">Android学习笔记-02 Android 四大核心组件之Service</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2014-08-27T09:50:00">
                三 27 八月 2014
        </abbr>
<p>tags: <a href="./tag/androidxue-xi-bi-ji.html">Android学习笔记</a><a href="./tag/android.html">Android</a></p></footer><!-- /.post-info -->      <h1>Android学习笔记-02 Android 四大核心组件之Service</h1>
<h2>一、Service声明</h2>
<ol>
<li>新建基于Service的类</li>
<li>在Mainifest中添加Service</li>
<li>在aty中添加两个按钮btnStart, btnStop</li>
<li>添加方法，让main实现OnClickListener</li>
</ol>
<div class="highlight"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="n">View</span> <span class="n">v</span><span class="o">){</span>
    <span class="k">switch</span> <span class="o">(</span><span class="n">v</span><span class="o">.</span><span class="na">getId</span><span class="o">()){</span>
    <span class="k">case</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">btnStart</span><span class="o">:</span>
        <span class="k">break</span><span class="o">;</span>
    <span class="k">case</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">btnStop</span><span class="o">:</span>
        <span class="k">break</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<ol>
<li>创建Intent 
serviceIntent = new Intent(this, EchoService.class)</li>
<li>
<p>在btn的click方法中startService(serviceIntent)和stopService(serviceIntent)</p>
</li>
<li>
<p>在service类中重写onCreate() onDestroy()方法
eclipse cmd+d:删除行</p>
</li>
</ol>
<h2>二、绑定服务</h2>
<ol>
<li>创建btn1,2</li>
<li>在click中bindService(serviceIntent, this, Content)，unBind</li>
<li>让class实现</li>
<li>在Service中创建onBind()</li>
</ol>
<div class="highlight"><pre><span class="kd">public</span> <span class="n">IBinder</span> <span class="nf">onBind</span><span class="o">(</span><span class="n">Intent</span> <span class="n">arg0</span><span class="o">){</span><span class="k">return</span> <span class="n">esb</span><span class="o">;}</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="n">EchoServiceBinder</span> <span class="n">esb</span> <span class="o">=</span> <span class="k">new</span> <span class="o">...{}</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EchoServiceBinder</span> <span class="kd">extends</span> <span class="n">Binder</span><span class="o">{</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></div>


<p><strong>注意</strong>：</p>
<ul>
<li>通过start service的服务在aty销毁时不会销毁</li>
<li>bind service的夫妇在aty销毁时会跟着销毁</li>
</ul>
<h2>三、service与aty通信</h2>
<ol>
<li>在service中添加timer和tasktimer</li>
</ol>
<div class="highlight"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">startTimer</span><span class="o">(){</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">timer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
        <span class="n">timer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Timer</span><span class="o">();</span>
        <span class="n">timerTask</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TimerTask</span><span class="o">()</span> <span class="o">{</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="n">i</span><span class="o">++;</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>

            <span class="o">}</span>
        <span class="o">};</span>

        <span class="n">timer</span><span class="o">.</span><span class="na">schedule</span><span class="o">(</span><span class="n">timerTask</span><span class="o">,</span> <span class="mi">1000</span><span class="o">,</span> <span class="mi">1000</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">stopTimer</span><span class="o">(){</span>
    <span class="k">if</span><span class="o">(</span><span class="n">timer</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
        <span class="n">timerTask</span><span class="o">.</span><span class="na">cancel</span><span class="o">();</span>
        <span class="n">timer</span><span class="o">.</span><span class="na">cancel</span><span class="o">();</span>
        <span class="n">timer</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">timerTask</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="kd">private</span> <span class="n">Timer</span> <span class="n">timer</span><span class="o">;</span>
<span class="kd">private</span> <span class="n">TimerTask</span> <span class="n">timerTask</span><span class="o">;</span>
</pre></div>


<p><strong>这一步与service和activity通信无关，但是这一步可以用来做服务与服务器的通信</strong></p>
<ol>
<li>在service的<code>onCreate</code>和<code>unDestroy</code>方法中启动和停止timer</li>
</ol>
<div class="highlight"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onUnbind</span><span class="o">(</span><span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;服务-取消服务绑定&quot;</span><span class="o">);</span>
    <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">onUnbind</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Service Create&quot;</span><span class="o">);</span>
    <span class="n">startTimer</span><span class="o">();</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>


<ol>
<li>在service类中，提供公共方法，以备后面通信时使用，比如：</li>
</ol>
<div class="highlight"><pre><span class="kd">private</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

<span class="kd">public</span> <span class="kt">int</span> <span class="nf">getInt</span><span class="o">(){</span>
    <span class="k">return</span> <span class="n">i</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>


<ol>
<li>在Activity方法中获取Service对象</li>
</ol>
<div class="highlight"><pre><span class="kd">private</span> <span class="n">EchoService</span> <span class="n">echoService</span><span class="o">;</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onServiceConnected</span><span class="o">(</span><span class="n">ComponentName</span> <span class="n">name</span><span class="o">,</span> <span class="n">IBinder</span> <span class="n">binder</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;应用已经绑定服务&quot;</span><span class="o">);</span>
    <span class="n">echoService</span> <span class="o">=</span> <span class="o">((</span><span class="n">EchoService</span><span class="o">.</span><span class="na">EchoBinder</span><span class="o">)</span><span class="n">binder</span><span class="o">).</span><span class="na">getService</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>


<ol>
<li>最后就可以在Activity中使用Service了</li>
</ol>
<div class="highlight"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="n">View</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">switch</span><span class="o">(</span><span class="n">v</span><span class="o">.</span><span class="na">getId</span><span class="o">()){</span>
    <span class="c1">//...</span>
    <span class="k">case</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">btnUnbindService</span><span class="o">:</span>
        <span class="n">unbindService</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="n">echoService</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">break</span><span class="o">;</span>
    <span class="k">case</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">btnGetCurrentNumber</span><span class="o">:</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">echoService</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;当前获取的数字是：&quot;</span><span class="o">+</span><span class="n">echoService</span><span class="o">.</span><span class="na">getInt</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">break</span><span class="o">;</span>

    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="https://github.com/liulixiang1988/">GitHub</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://liulixiang1988.github.io/" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="http://weibo.com/liulixiang1988">微博</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                     Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>. Theme is using <a href="http://github.com/getpelican/pelican-themes" target="_blank">cebong</a>.
                </address><!-- /#about -->

        </footer><!-- /#contentinfo -->

</body>
</html>