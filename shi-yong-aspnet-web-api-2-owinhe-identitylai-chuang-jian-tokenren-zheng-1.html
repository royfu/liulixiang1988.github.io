<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>使用ASP.NET Web API 2、Owin和Identity来创建Token认证(1)</title>
  <meta name="author" content="理想">



  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="./favicon.png" rel="icon">
  <link href="./theme/css/main.css" media="screen, projection"
        rel="stylesheet" type="text/css">
  <script src="./theme/js/modernizr-2.0.js"></script>
  <script src="./theme/js/ender.js"></script>
  <script src="./theme/js/octopress.js" type="text/javascript"></script>

  <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
</head>

<body>
  <header role="banner"><hgroup>
  <h1><a href="./">理想国</a></h1>
</hgroup></header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
</ul>


<form action="//google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:." />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>

<ul class="main-navigation">
    <li >
    <a href="./category/android.html">Android</a>
    </li>
    <li class="active">
    <a href="./category/dotnet.html">Dotnet</a>
    </li>
    <li >
    <a href="./category/net.html">.net</a>
    </li>
    <li >
    <a href="./category/python.html">Python</a>
    </li>
    <li >
    <a href="./category/sheng-huo.html">生活</a>
    </li>
</ul></nav>
  <div id="main">
    <div id="content">
<div>
  <article class="hentry" role="article">
<header>
      <h1 class="entry-title">使用ASP.NET Web API 2、Owin和Identity来创建Token认证(1)</h1>
      <p class="meta"><time datetime="2014-10-30T00:00:00" pubdate>四 30 十月 2014</time></p>
</header>

  <div class="entry-content"><h1>使用ASP.NET Web API 2、Owin和Identity来创建Token认证(1)</h1>
<h2>0. 简介</h2>
<h3>0.1 Token认证</h3>
<h3>0.2 Web API</h3>
<hr />
<h2>1. 创建后端API</h2>
<h3>1.1 第一步 创建Web API项目</h3>
<p>使用VS2013，创建"ASP.NET Web应用程序"，解决方案名为AngularJSAuthentication，项目名为AngularJSAuthentication.API:</p>
<p><img alt="Alt text" src="1414648763551.png" /></p>
<h3>1.2 第二步 安装必要的NuGet包</h3>
<div class="highlight"><pre><span class="n">Install</span><span class="o">-</span><span class="n">Package</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">AspNet</span><span class="p">.</span><span class="n">WebApi</span><span class="p">.</span><span class="n">Owin</span> <span class="o">-</span><span class="n">Version</span> <span class="mf">5.1.2</span>
<span class="n">Install</span><span class="o">-</span><span class="n">Package</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">Owin</span><span class="p">.</span><span class="n">Host</span><span class="p">.</span><span class="n">SystemWeb</span> <span class="o">-</span><span class="n">Version</span> <span class="mf">2.1.0</span>
</pre></div>


<p>其中，<code>Microsoft.Owin.Host.SystemWeb</code>包是用来Owin服务器的API能够在IIS上运行</p>
<h3>1.3 第三步 添加Owin"启动(Startup)"类</h3>
<p>右键，添加新类<code>Startup</code>，我们会修改好几次这个类，现在它应该是这个样子：</p>
<div class="highlight"><pre><span class="n">using</span> <span class="n">System</span><span class="p">.</span><span class="n">Web</span><span class="p">.</span><span class="n">Http</span><span class="p">;</span>
<span class="n">using</span> <span class="n">AngularJSAuthentication</span><span class="p">.</span><span class="n">API</span><span class="p">;</span>
<span class="n">using</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">Owin</span><span class="p">;</span>
<span class="n">using</span> <span class="n">Owin</span><span class="p">;</span>

<span class="p">[</span><span class="n">assembly</span><span class="o">:</span> <span class="n">OwinStartup</span><span class="p">(</span><span class="n">typeof</span> <span class="p">(</span><span class="n">Startup</span><span class="p">))]</span>

<span class="n">namespace</span> <span class="n">AngularJSAuthentication</span><span class="p">.</span><span class="n">API</span>
<span class="p">{</span>
    <span class="n">public</span> <span class="n">class</span> <span class="n">Startup</span>
    <span class="p">{</span>
        <span class="n">public</span> <span class="kt">void</span> <span class="n">Configuration</span><span class="p">(</span><span class="n">IAppBuilder</span> <span class="n">app</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">var</span> <span class="n">config</span> <span class="o">=</span> <span class="n">new</span> <span class="n">HttpConfiguration</span><span class="p">();</span>
            <span class="n">WebApiConfig</span><span class="p">.</span><span class="n">Register</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
            <span class="n">app</span><span class="p">.</span><span class="n">UseWebApi</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p><code>assembly</code>属性声明了启动时启动的类，也就是说<code>Startup</code>类在应用启动的时候会被调用。<code>Configuration</code>方法接收的参数<code>IAppBuilder</code>实例app是主机传过来的。<code>app</code>是一个接口，用来组成我们服务器的应用。</p>
<p><code>HttpConfiguration</code>对象用来配置路由，因此，我们把它传递给<code>WebApiConfig</code>类的<code>Register</code>方法。</p>
<p>最后，我们把<code>config</code>对象传递给<code>UserWebApi</code>扩展方法，实现ASP.NET Web API和Owin Server的管道。</p>
<p>通常，<code>WebApiConfig</code>由模板自动生成。如果没有，就在<code>App_Start</code>文件夹下创建：</p>
<div class="highlight"><pre><span class="k">public</span> <span class="nf">static</span> <span class="nb">class</span> <span class="nx">WebApiConfig</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">static</span> <span class="bp">void</span> <span class="nb">Register</span><span class="p">(</span><span class="nx">HttpConfiguration</span> <span class="nx">config</span><span class="p">)</span>
    <span class="p">{</span>

        <span class="c1">// Web API routes</span>
        <span class="nx">config.MapHttpAttributeRoutes</span><span class="p">();</span>

        <span class="nx">config.Routes.MapHttpRoute</span><span class="p">(</span>
            <span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;DefaultApi&quot;</span><span class="p">,</span>
            <span class="nx">routeTemplate</span><span class="p">:</span> <span class="s2">&quot;api/{controller}/{id}&quot;</span><span class="p">,</span>
            <span class="nx">defaults</span><span class="p">:</span> <span class="nb">new</span> <span class="p">{</span> <span class="n">id</span> <span class="o">=</span> <span class="nx">RouteParameter.Optional</span> <span class="p">}</span>
        <span class="p">);</span>

        <span class="kd">var</span> <span class="n">jsonFormatter</span> <span class="o">=</span> <span class="nx">config.Formatters.OfType</span><span class="o">&lt;</span><span class="nx">JsonMediaTypeFormatter</span><span class="o">&gt;</span><span class="p">()</span><span class="bp">.</span><span class="nb">First</span><span class="p">();</span>
        <span class="n">jsonFormatter.SerializerSettings.ContractResolver</span> <span class="o">=</span> <span class="nb">new</span> <span class="nx">CamelCasePropertyNamesContractResolver</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h3>1.4 第四步 删除Global.asax类</h3>
<p>不再需要这个类，也不需要<code>Application_Start</code>事件，因为我们已经配置了<code>Startup</code>类，所以放心删除它吧。</p>
<h3>1.5 第五步 添加Windows Identity System(Windows身份认证系统)</h3>
<p>配置过Web API后，现在可以添加支持注册和验证用户的包了，安装如下包</p>
<div class="highlight"><pre><span class="n">Install</span><span class="o">-</span><span class="n">Package</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">AspNet</span><span class="p">.</span><span class="n">Identity</span><span class="p">.</span><span class="n">Owin</span> <span class="o">-</span><span class="n">Version</span> <span class="mf">2.0.1</span>
<span class="n">Install</span><span class="o">-</span><span class="n">Package</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">AspNet</span><span class="p">.</span><span class="n">Identity</span><span class="p">.</span><span class="n">EntityFramework</span> <span class="o">-</span><span class="n">Version</span> <span class="mf">2.0.1</span>
</pre></div>


<p>第一个包用来支持ASP.NET Identity Owin，第二个包可以让ASP.NET Identity使用Entity Framework,这样我们就能保存用户到SQL Server数据库了。</p>
<p>现在我们需要添加一个Database context类，用来负责与数据库交互。因此，添加<code>AuthContext</code>类：</p>
<div class="highlight"><pre><span class="k">public</span> <span class="nf">class</span> <span class="nx">AuthContext</span><span class="p">:</span> <span class="nx">IdentityDbContext</span><span class="o">&lt;</span><span class="nx">IdentityUser</span><span class="o">&gt;</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">AuthContext</span><span class="p">():</span> <span class="nx">base</span><span class="p">(</span><span class="s2">&quot;AuthContext&quot;</span><span class="p">)</span>
    <span class="p">{</span>

    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>能看到这个类继承自<code>IdentityDbContext</code>类。可以把这个特殊类型的<code>DbContext</code>类。它支持所有Entity Framework的code-first映射，以及DbSet属性用来管理数据库的身份表。可以读<a href="http://odetocode.com/blogs/scott/archive/2014/01/03/asp-net-identity-with-the-entity-framework.aspx">Scott Allen的博客</a>了解更多。</p>
<p>现在，我们在<code>Models</code>文件夹下添加一个<code>UserModel</code>类，它包含一些用来验证注册请求。</p>
<div class="highlight"><pre><span class="n">using</span> <span class="n">System</span><span class="p">.</span><span class="n">ComponentModel</span><span class="p">.</span><span class="n">DataAnnotations</span><span class="p">;</span>

<span class="n">namespace</span> <span class="n">AngularJSAuthentication</span><span class="p">.</span><span class="n">API</span><span class="p">.</span><span class="n">Models</span>
<span class="p">{</span>
    <span class="n">public</span> <span class="n">class</span> <span class="n">UserModel</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="n">Required</span><span class="p">]</span>
        <span class="p">[</span><span class="n">Display</span><span class="p">(</span><span class="n">Name</span> <span class="o">=</span> <span class="s">&quot;用户名&quot;</span><span class="p">)]</span>
        <span class="n">public</span> <span class="n">string</span> <span class="n">UserName</span> <span class="p">{</span> <span class="n">get</span><span class="p">;</span> <span class="n">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="p">[</span><span class="n">Required</span><span class="p">]</span>
        <span class="p">[</span><span class="n">StringLength</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">ErrorMessage</span> <span class="o">=</span> <span class="s">&quot;{0}至少要有{2}个字符&quot;</span><span class="p">,</span> <span class="n">MinimumLength</span> <span class="o">=</span> <span class="mi">6</span><span class="p">)]</span>
        <span class="p">[</span><span class="n">DataType</span><span class="p">(</span><span class="n">DataType</span><span class="p">.</span><span class="n">Password</span><span class="p">)]</span>
        <span class="p">[</span><span class="n">Display</span><span class="p">(</span><span class="n">Name</span> <span class="o">=</span> <span class="s">&quot;密码&quot;</span><span class="p">)]</span>
        <span class="n">public</span> <span class="n">string</span> <span class="n">Password</span> <span class="p">{</span> <span class="n">get</span><span class="p">;</span> <span class="n">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="p">[</span><span class="n">DataType</span><span class="p">(</span><span class="n">DataType</span><span class="p">.</span><span class="n">Password</span><span class="p">)]</span>
        <span class="p">[</span><span class="n">Display</span><span class="p">(</span><span class="n">Name</span> <span class="o">=</span> <span class="s">&quot;确认密码&quot;</span><span class="p">)]</span>
        <span class="p">[</span><span class="n">Compare</span><span class="p">(</span><span class="s">&quot;Password&quot;</span><span class="p">,</span> <span class="n">ErrorMessage</span> <span class="o">=</span> <span class="s">&quot;两次密码输入不一致&quot;</span><span class="p">)]</span>
        <span class="n">public</span> <span class="n">string</span> <span class="n">ConfirmedPassword</span> <span class="p">{</span> <span class="n">get</span><span class="p">;</span> <span class="n">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>最后，我们在web.config中添加连接字符串：</p>
<div class="highlight"><pre><span class="nt">&lt;connectionStrings&gt;</span>
<span class="nt">&lt;add</span> <span class="na">name=</span><span class="s">&quot;AuthContext&quot;</span> <span class="na">connectionString=</span><span class="s">&quot;Data Source=.;Initial Catalog=AngularJSAuth;Integrated Security=SSPI;&quot;</span> <span class="na">providerName=</span><span class="s">&quot;System.Data.SqlClient&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/connectionStrings&gt;</span>
</pre></div>


<h3>1.6 第六步 添加仓库类来支持ASP.NET Identity System</h3>
<p>现在，我们要实现两个方法<code>RegisterUser</code>和<code>FindUser</code>，因此，我们添加一个名为<code>AuthRepository</code>的类：</p>
<div class="highlight"><pre><span class="k">public</span> <span class="nf">class</span> <span class="nx">AuthRepository</span> <span class="p">:</span> <span class="nx">IDisposable</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nf">readonly</span> <span class="nx">AuthContext</span> <span class="nx">_ctx</span><span class="p">;</span>

    <span class="k">private</span> <span class="nf">readonly</span> <span class="nx">UserManager</span><span class="o">&lt;</span><span class="nx">IdentityUser</span><span class="o">&gt;</span> <span class="nx">_userManager</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">AuthRepository</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">_ctx</span> <span class="o">=</span> <span class="nb">new</span> <span class="nx">AuthContext</span><span class="p">();</span>
        <span class="n">_userManager</span> <span class="o">=</span> <span class="nb">new</span> <span class="nx">UserManager</span><span class="o">&lt;</span><span class="nx">IdentityUser</span><span class="o">&gt;</span><span class="p">(</span><span class="na">new</span> <span class="nx">UserStore</span><span class="o">&lt;</span><span class="nx">IdentityUser</span><span class="o">&gt;</span><span class="p">(</span><span class="na">_ctx</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="nf">void</span> <span class="nx">Dispose</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nx">_ctx.Dispose</span><span class="p">();</span>
        <span class="nx">_userManager.Dispose</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="nf">async</span> <span class="nx">Task</span><span class="o">&lt;</span><span class="nx">IdentityResult</span><span class="o">&gt;</span> <span class="nx">RegisterUser</span><span class="p">(</span><span class="nx">UserModel</span> <span class="nx">userModel</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="n">user</span> <span class="o">=</span> <span class="nb">new</span> <span class="nx">IdentityUser</span>
        <span class="p">{</span>
            <span class="n">UserName</span> <span class="o">=</span> <span class="nx">userModel.UserName</span>
        <span class="p">};</span>

        <span class="nx">IdentityResult</span> <span class="n">result</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">_userManager.CreateAsync</span><span class="p">(</span><span class="nb">user</span><span class="p">,</span> <span class="nx">userModel.Password</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">result</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="nf">async</span> <span class="nx">Task</span><span class="o">&lt;</span><span class="nx">IdentityUser</span><span class="o">&gt;</span> <span class="nx">FindUser</span><span class="p">(</span><span class="kt">string</span> <span class="nx">username</span><span class="p">,</span> <span class="kt">string</span> <span class="nx">password</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">IdentityUser</span> <span class="n">user</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">_userManager.FindAsync</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">user</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>我们依赖<code>UserManager</code>来提供用户信息的逻辑操作。<code>UserManager</code>指导什么时候hash密码，怎么以及何时验证用户，以及如何管理请求。读<a href="http://odetocode.com/blogs/scott/archive/2014/01/20/implementing-asp-net-identity.aspx">ASP.NET Identity System</a>来了解更多。</p>
<h3>1.7 第七步 添加我们的“账户”控制器("Account" Controller)</h3>
<p>现在是时候添加我们的第一个Web API控制器了，这个控制器用来注册新用户。在<code>Controllers</code>文件夹下添加一个空Web API 2的控制器<code>AccountController</code>：</p>
<div class="highlight"><pre><span class="k">[RoutePrefix(&quot;api/account&quot;)]</span>
<span class="err">public</span> <span class="err">class</span> <span class="err">AccountController</span> <span class="err">:</span> <span class="err">ApiController</span>
<span class="err">{</span>
    <span class="na">private AuthRepository _repo</span> <span class="o">=</span> <span class="s">null;</span>

    <span class="err">public</span> <span class="err">AccountController()</span>
    <span class="err">{</span>
        <span class="na">_repo</span> <span class="o">=</span> <span class="s">new AuthRepository();</span>
<span class="s">    }</span>

    <span class="err">//POST</span> <span class="err">/api/Acount/Register</span>
    <span class="k">[AllowAnonymous]</span>
    <span class="k">[Route(&quot;Register&quot;)]</span>
    <span class="err">public</span> <span class="err">async</span> <span class="err">Task&lt;IHttpActionResult&gt;</span> <span class="err">Register(UserModel</span> <span class="err">userModel)</span>
    <span class="err">{</span>
        <span class="err">if</span> <span class="err">(!ModelState.IsValid)</span>
        <span class="err">{</span>
            <span class="err">return</span> <span class="err">BadRequest(ModelState)</span><span class="c1">;</span>
        <span class="err">}</span>

        <span class="na">IdentityResult result</span> <span class="o">=</span> <span class="s">await _repo.RegisterUser(userModel);</span>
<span class="s">        IHttpActionResult errorResult = GetErrorResult(result);</span>
<span class="s">        if (errorResult != null)</span>
<span class="s">        {</span>
<span class="s">            return errorResult;</span>
<span class="s">        }</span>

        <span class="err">return</span> <span class="err">Ok()</span><span class="c1">;</span>
    <span class="err">}</span>

    <span class="err">protected</span> <span class="err">override</span> <span class="err">void</span> <span class="err">Dispose(bool</span> <span class="err">disposing)</span>
    <span class="err">{</span>
        <span class="err">if</span> <span class="err">(disposing)</span>
        <span class="err">{</span>
            <span class="err">_repo.Dispose()</span><span class="c1">;</span>
        <span class="err">}</span>
        <span class="err">base.Dispose(disposing)</span><span class="c1">;</span>
    <span class="err">}</span>

    <span class="err">private</span> <span class="err">IHttpActionResult</span> <span class="err">GetErrorResult(IdentityResult</span> <span class="err">result)</span>
    <span class="err">{</span>
        <span class="na">if (result</span> <span class="o">=</span><span class="s">= null)</span>
<span class="s">        {</span>
<span class="s">            return InternalServerError();</span>
<span class="s">        }</span>

        <span class="err">if</span> <span class="err">(!result.Succeeded)</span>
        <span class="err">{</span>
            <span class="na">if (result.Errors !</span><span class="o">=</span> <span class="s">null)</span>
<span class="s">            {</span>
<span class="s">                foreach (var error in result.Errors)</span>
<span class="s">                {</span>
<span class="s">                    ModelState.AddModelError(&quot;&quot;, error);</span>
<span class="s">                }</span>
<span class="s">            }</span>

            <span class="err">if</span> <span class="err">(ModelState.IsValid)</span>
            <span class="err">{</span>
                <span class="err">return</span> <span class="err">BadRequest()</span><span class="c1">;</span>
            <span class="err">}</span>
            <span class="err">return</span> <span class="err">BadRequest(ModelState)</span><span class="c1">;</span>
        <span class="err">}</span>
        <span class="err">return</span> <span class="err">null</span><span class="c1">;</span>
    <span class="err">}</span>
<span class="err">}</span>
</pre></div>


<p>任何人想要注册，必须使用HTTP POST请求'/api/account/register'，而且请求必须包含如下的JSON对象：</p>
<div class="highlight"><pre><span class="p">{</span>
    <span class="s">&quot;userName&quot;</span><span class="o">:</span> <span class="s">&quot;liu&quot;</span><span class="p">,</span>
    <span class="s">&quot;password&quot;</span><span class="o">:</span> <span class="s">&quot;123456&quot;</span><span class="p">,</span>
    <span class="s">&quot;confirmPassword&quot;</span><span class="o">:</span> <span class="s">&quot;123456&quot;</span>
<span class="p">}</span>
</pre></div>


<p>现在可以使用HTTP POST请求网址：“http://localhost:port/api/account/register”，如果一切正常就会收到HTTP状态码200，而且数据库会自动在表<code>dbo.AspNetUsers</code>中创建一个用户。</p>
<p><strong>注意：</strong>通过HTTPS发送POST请求非常重要，因为敏感信息会被加密。</p>
<p><code>GetErrorResult</code>方法是一个帮助方法用来验证<code>UserModel</code>，并且返回相应的HTTP状态码。</p>
<h3>1.8 第八步 添加具有安全保护的“订单”控制器(Order Controller)</h3>
<p>现在我们想要添加控制器来处理我们的订单，我们设定这个控制器为认证用户返回订单，为了保持简单我们返回静态数据。因此在<code>Controllers</code>下添加一个<code>OrdersController</code>：</p>
<div class="highlight"><pre><span class="k">[RoutePrefix(&quot;api/Orders&quot;)]</span>
<span class="err">public</span> <span class="err">class</span> <span class="err">OrdersController</span> <span class="err">:</span> <span class="err">ApiController</span>
<span class="err">{</span>
    <span class="err">//</span> <span class="err">GET</span> <span class="err">api/&lt;controller&gt;</span>
    <span class="k">[Authorize]</span>
    <span class="k">[Route(&quot;&quot;)]</span>
    <span class="err">public</span> <span class="err">IHttpActionResult</span> <span class="err">Get()</span>
    <span class="err">{</span>
        <span class="err">return</span> <span class="err">Ok(Order.CreateOrders())</span><span class="c1">;</span>
    <span class="err">}</span>

    <span class="c1">#region Helpers</span>

    <span class="err">public</span> <span class="err">class</span> <span class="err">Order</span>
    <span class="err">{</span>
        <span class="err">public</span> <span class="err">int</span> <span class="err">OrderID</span> <span class="err">{</span> <span class="err">get</span><span class="c1">; set; }</span>
        <span class="err">public</span> <span class="err">string</span> <span class="err">CustomerName</span> <span class="err">{</span> <span class="err">get</span><span class="c1">; set; }</span>
        <span class="err">public</span> <span class="err">string</span> <span class="err">ShipperCity</span> <span class="err">{</span> <span class="err">get</span><span class="c1">; set; }</span>
        <span class="err">public</span> <span class="err">Boolean</span> <span class="err">IsShipped</span> <span class="err">{</span> <span class="err">get</span><span class="c1">; set; }</span>

        <span class="err">public</span> <span class="err">static</span> <span class="err">List&lt;Order&gt;</span> <span class="err">CreateOrders()</span>
        <span class="err">{</span>
            <span class="na">var OrderList</span> <span class="o">=</span> <span class="s">new List&lt;Order&gt; </span>
<span class="s">            {</span>
<span class="s">                new Order {OrderID = 10248, CustomerName = &quot;Taiseer Joudeh&quot;, ShipperCity = &quot;Amman&quot;, IsShipped = true },</span>
<span class="s">                new Order {OrderID = 10249, CustomerName = &quot;Ahmad Hasan&quot;, ShipperCity = &quot;Dubai&quot;, IsShipped = false},</span>
<span class="s">                new Order {OrderID = 10250,CustomerName = &quot;Tamer Yaser&quot;, ShipperCity = &quot;Jeddah&quot;, IsShipped = false },</span>
<span class="s">                new Order {OrderID = 10251,CustomerName = &quot;Lina Majed&quot;, ShipperCity = &quot;Abu Dhabi&quot;, IsShipped = false},</span>
<span class="s">                new Order {OrderID = 10252,CustomerName = &quot;Yasmeen Rami&quot;, ShipperCity = &quot;Kuwait&quot;, IsShipped = true}</span>
<span class="s">            };</span>

            <span class="err">return</span> <span class="err">OrderList</span><span class="c1">;</span>
        <span class="err">}</span>
    <span class="err">}</span>

    <span class="c1">#endregion</span>
<span class="err">}</span>
</pre></div>


<p>注意我们在<code>Get</code>上加了一个<code>Authorize</code>属性，此时，如果访问 “http://localhost:port/api/orders”就会收到401未授权状态码。因为我们的请求当中并没有包含授权头信息。</p>
<h3>1.9 第九步 添加支持OAuth Token生成功能</h3>
<p>现在我们该让API增加OAuth功能</p>
<div class="highlight"><pre><span class="n">Install</span><span class="o">-</span><span class="n">Package</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">Owin</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">OAuth</span> <span class="o">-</span><span class="n">Version</span> <span class="mf">2.1.0</span>
</pre></div>


<p>打开<code>Startup</code>类，添加<code>ConfigureOAuth</code>方法，并在<code>Configuration</code>方法的第一行调用它：</p>
<div class="highlight"><pre><span class="n">public</span> <span class="n">class</span> <span class="n">Startup</span>
    <span class="p">{</span>
        <span class="n">public</span> <span class="kt">void</span> <span class="n">Configuration</span><span class="p">(</span><span class="n">IAppBuilder</span> <span class="n">app</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">var</span> <span class="n">config</span> <span class="o">=</span> <span class="n">new</span> <span class="n">HttpConfiguration</span><span class="p">();</span>
            <span class="n">WebApiConfig</span><span class="p">.</span><span class="n">Register</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
            <span class="n">app</span><span class="p">.</span><span class="n">UseWebApi</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">public</span> <span class="kt">void</span> <span class="n">ConfigreOAuth</span><span class="p">(</span><span class="n">IAppBuilder</span> <span class="n">app</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">var</span> <span class="n">oauthServerOptions</span> <span class="o">=</span> <span class="n">new</span> <span class="n">OAuthAuthorizationServerOptions</span>
            <span class="p">{</span>
                <span class="n">AllowInsecureHttp</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
                <span class="n">TokenEndpointPath</span> <span class="o">=</span> <span class="n">new</span> <span class="n">PathString</span><span class="p">(</span><span class="s">&quot;/token&quot;</span><span class="p">),</span>
                <span class="n">AccessTokenExpireTimeSpan</span> <span class="o">=</span> <span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromDays</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">Provider</span> <span class="o">=</span> <span class="n">new</span> <span class="n">SimpleAuthorizationServerProvider</span><span class="p">()</span>
            <span class="p">};</span>

            <span class="n">app</span><span class="p">.</span><span class="n">UseOAuthAuthorizationServer</span><span class="p">(</span><span class="n">oauthServerOptions</span><span class="p">);</span>
            <span class="n">app</span><span class="p">.</span><span class="n">UseOAuthBearerAuthentication</span><span class="p">(</span><span class="n">new</span> <span class="n">OAuthBearerAuthenticationOptions</span><span class="p">());</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></div>


<p>我们创建了一个<code>OAuthAuthorizationServerOptions</code>类的实例，并且设置了如下的一些选项：</p>
<ul>
<li>产生令牌的路径<code>http://localhost:port/token</code>。后面我们会看到如何使用HTTP POST请求产生令牌</li>
<li>令牌24小时过期</li>
<li>我们指明如何验证用户的凭据，来返回令牌，就是使用后面我们要定义的一个类<code>SimpleAuthorizationServerProvider</code></li>
</ul>
<p>然后将选项实例传递给扩展方法<code>UseOAuthAuthorizationServer</code>，这样我们就将认证中间件添加到了管道当中去了。</p>
<h3>1.10 第十步 实现"SimpleAuthorizationServerProvider"类</h3>
<p>创建一个<code>Providers</code>文件夹，然后添加一个<code>SimpleAuthorizationServerProvider</code>类：</p>
<div class="highlight"><pre><span class="n">public</span> <span class="n">class</span> <span class="n">SimpleAuthorizationServerProvider</span><span class="o">:</span> <span class="n">OAuthAuthorizationServerProvider</span>
<span class="p">{</span>

    <span class="n">public</span> <span class="n">override</span> <span class="n">async</span> <span class="n">Task</span> <span class="n">ValidateClientAuthentication</span><span class="p">(</span><span class="n">OAuthValidateClientAuthenticationContext</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">context</span><span class="p">.</span><span class="n">Validated</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">public</span> <span class="n">override</span> <span class="n">async</span> <span class="n">Task</span> <span class="n">GrantResourceOwnerCredentials</span><span class="p">(</span><span class="n">OAuthGrantResourceOwnerCredentialsContext</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">context</span><span class="p">.</span><span class="n">OwinContext</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">Headers</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s">&quot;Access-Control-Allow-Origin&quot;</span><span class="p">,</span> <span class="n">new</span> <span class="p">[]{</span><span class="s">&quot;*&quot;</span><span class="p">});</span>

        <span class="n">using</span> <span class="p">(</span><span class="n">var</span> <span class="n">_repo</span> <span class="o">=</span> <span class="n">new</span> <span class="n">AuthRepository</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="n">IdentityUser</span> <span class="n">user</span> <span class="o">=</span> <span class="n">await</span> <span class="n">_repo</span><span class="p">.</span><span class="n">FindUser</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">UserName</span><span class="p">,</span> <span class="n">context</span><span class="p">.</span><span class="n">Password</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">user</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">context</span><span class="p">.</span><span class="n">SetError</span><span class="p">(</span><span class="s">&quot;invalid_grant&quot;</span><span class="p">,</span> <span class="s">&quot;用户名或者密码不正确&quot;</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">var</span> <span class="n">identity</span> <span class="o">=</span> <span class="n">new</span> <span class="n">ClaimsIdentity</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">Options</span><span class="p">.</span><span class="n">AuthenticationType</span><span class="p">);</span>
            <span class="n">identity</span><span class="p">.</span><span class="n">AddClaim</span><span class="p">(</span><span class="n">new</span> <span class="n">Claim</span><span class="p">(</span><span class="s">&quot;sub&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">.</span><span class="n">UserName</span><span class="p">));</span>
            <span class="n">identity</span><span class="p">.</span><span class="n">AddClaim</span><span class="p">(</span><span class="n">new</span> <span class="n">Claim</span><span class="p">(</span><span class="s">&quot;role&quot;</span><span class="p">,</span> <span class="s">&quot;user&quot;</span><span class="p">));</span>

            <span class="n">context</span><span class="p">.</span><span class="n">Validated</span><span class="p">(</span><span class="n">identity</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>该类继承自<code>OAuthAuthorizationServerProvider</code>，我们重写了两个方法，第一个是用来验证客户端的。本例中我们只有一个客户端，因此永远验证成功。</p>
<p>第二个方法<code>GrantResourceOwnerCredentials</code>负责验证发送给认证服务器令牌端的用户名和密码。</p>
<p>如果认证成功，我们创建一个<code>ClaimsIdentity</code>类，并且传递认证类型给它。然后添加两个请求(<code>sub</code>和<code>role</code>)，他们会被包含在签名令牌中。也可以添加别的,但是会增加令牌的大小。</p>
<p>最后使用<code>context.Validate(identity)</code>生成令牌。</p>
<p>为了让令牌中间件提供者允许CORS，我们需要添加头"Access-Control-Allow-Origin"到Owin的上下文中。如果忘记这么做，从浏览器中调用生成令牌就会失败。</p>
<h3>1.11 第十一步 允许ASP.NET Web API支持CORS</h3>
<p>首先，需要安装对应的NuGet包：</p>
<div class="highlight"><pre><span class="n">Install</span><span class="o">-</span><span class="n">Package</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">Owin</span><span class="p">.</span><span class="n">Cors</span>
</pre></div>


<p>然后再次打开类<code>Startup</code>，并添加</p>
<div class="highlight"><pre><span class="n">public</span> <span class="kt">void</span> <span class="nf">Configuration</span><span class="p">(</span><span class="n">IAppBuilder</span> <span class="n">app</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">var</span> <span class="n">config</span> <span class="o">=</span> <span class="n">new</span> <span class="n">HttpConfiguration</span><span class="p">();</span>
    <span class="n">ConfigreOAuth</span><span class="p">(</span><span class="n">app</span><span class="p">);</span>

    <span class="n">WebApiConfig</span><span class="p">.</span><span class="n">Register</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
    <span class="c1">//添加这行</span>
    <span class="n">app</span><span class="p">.</span><span class="n">UseCors</span><span class="p">(</span><span class="n">CorsOptions</span><span class="p">.</span><span class="n">AllowAll</span><span class="p">);</span>
    <span class="n">app</span><span class="p">.</span><span class="n">UseWebApi</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<h3>1.12 第十二步 测试后端API</h3>
<p><img alt="Alt text" src="1414678902732.png" /></p>
<p>注意，content-type和payload type都是"x-www-form-urlencoded"类型，因此payload body将是form(grant_type=password&amp;username="liulx"&amp;password="123456")。如果一切正常我们会在响应中收到一个签名令牌。</p>
<p>"grant_type"指明授权类型，此处是密码。</p>
<p>现在既然有了token，我们就可以访问安全数据/api/Orders了：</p>
<p><img alt="Alt text" src="1414679319878.png" /></p></div>
    <footer>
<p class="meta">
  <span class="byline author vcard">
    Posted by <span class="fn">刘理想</span>
  </span>
<time datetime="2014-10-30T00:00:00" pubdate>四 30 十月 2014</time></p><div class="sharing">
</div>    </footer>
  </article>

  <section>
    <h1>Comments</h1>
    <div id="DuoShuoComment" aria-live="polite">
<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="shi-yong-aspnet-web-api-2-owinhe-identitylai-chuang-jian-tokenren-zheng-1.html" data-title="使用ASP.NET Web API 2、Owin和Identity来创建Token认证(1)" data-url="./shi-yong-aspnet-web-api-2-owinhe-identitylai-chuang-jian-tokenren-zheng-1.html"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"liulixiang1988blog"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- 多说公共JS代码 end -->
    </div>
  </section>
</div>
<aside class="sidebar">
  <section>
	  <img src="./images/avatar.jpg" alt="刘理想" width=""/> 
  </section>
  <section>
    <h1>Recent Posts</h1>
    <ul id="recent_posts">
      <li class="post">
          <a href="./shi-yong-aspnet-web-api-2-owinhe-identitylai-chuang-jian-tokenren-zheng-1.html">使用ASP.NET Web API 2、Owin和Identity来创建Token认证(1)</a>
      </li>
      <li class="post">
          <a href="./shi-yong-androidkai-fa-yue-hou-ji-fen-ying-yong-01-kai-shi.html">使用Android开发阅后即焚应用-01 开始</a>
      </li>
      <li class="post">
          <a href="./shi-yong-androidkai-fa-yi-ge-bo-ke-yue-du-qi-05-shi-yong-intentxian-shi-he-gong-xiang-bo-ke.html">使用Android开发一个博客阅读器-05 使用Intent显示和共享博客</a>
      </li>
      <li class="post">
          <a href="./shi-yong-androidkai-fa-yi-ge-bo-ke-yue-du-qi-04-zai-listzhong-zhan-xian-shu-ju.html">使用Android开发一个博客阅读器-04 在List中展现数据</a>
      </li>
      <li class="post">
          <a href="./django-sql-servershu-ju-ku-qu-dong-gen-ju-xian-you-shu-ju-ku-sheng-cheng-modelsyi-ji-shu-ju-ku-qian-yi.html">Django SQL Server数据库驱动,根据现有数据库生成models以及数据库迁移</a>
      </li>
    </ul>
  </section>
  <section>
      
    <h1>Categories</h1>
    <ul id="recent_posts">
        <li><a href="./category/android.html">Android</a></li>
        <li><a href="./category/dotnet.html">DotNet</a></li>
        <li><a href="./category/net.html">.NET</a></li>
        <li><a href="./category/python.html">Python</a></li>
        <li><a href="./category/sheng-huo.html">生活</a></li>
    </ul>
  </section>
 

  <section>
  <h1>Tags</h1>
    <a href="./tag/androidxue-xi-bi-ji.html">Android学习笔记</a>,    <a href="./tag/pelican.html">pelican</a>,    <a href="./tag/android.html">Android</a>,    <a href="./tag/androibo-ke-yue-du.html">Androi博客阅读</a>,    <a href="./tag/life.html">life</a>,    <a href="./tag/web.html">web</a>,    <a href="./tag/python.html">Python</a>,    <a href="./tag/androiyue-hou-ji-fen.html">Androi阅后即焚</a>,    <a href="./tag/nancy.html">Nancy</a>,    <a href="./tag/django.html">Django</a>,    <a href="./tag/net.html">.NET</a>,    <a href="./tag/c.html">C#</a>  </section>



  <section>
    <h1>GitHub Repos</h1>
    <ul id="gh_repos">
      <li class="loading">Status updating...</li>
    </ul>
      <a href="https://github.com/liulixiang1988">@liulixiang1988</a> on GitHub
    <script type="text/javascript">
      $.domReady(function(){
          if (!window.jXHR){
              var jxhr = document.createElement('script');
              jxhr.type = 'text/javascript';
              jxhr.src = './theme/js/jXHR.js';
              var s = document.getElementsByTagName('script')[0];
              s.parentNode.insertBefore(jxhr, s);
          }

          github.showRepos({
              user: 'liulixiang1988',
              count: 5,
              skip_forks: false,
              target: '#gh_repos'
          });
      });
    </script>
    <script src="./theme/js/github.js" type="text/javascript"> </script>
  </section>

    <section>
        <h1>Social</h1>
        <ul>
            <li><a href="http://weibo.com/liulixiang1988" target="_blank">微博</a></li>
        </ul>
    </section>
    <section>
        <h1>Blogroll</h1>
        <ul>
            <li><a href="https://github.com/liulixiang1988/" target="_blank">GitHub</a></li>
        </ul>
    </section>

</aside>    </div>
  </div>
  <footer role="contentinfo"><p>
    Copyright &copy;  2014  - 理想 -
  <span class="credit">Powered by <a href="http://getpelican.com">Pelican</a></span>
</p></footer>
</body>
</html>